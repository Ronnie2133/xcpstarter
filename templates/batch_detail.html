{% extends "base.html" %}
{% block content %}

<h1>{{ b.name }}</h1>

<!-- Batch Meta: edit name, yield, unit, notes -->
<form action="{{ url_for('batch_update', batch_id=b.id) }}" method="post" class="card" style="margin-bottom:1rem;">
  <div style="display:flex; gap:1rem; flex-wrap:wrap;">
    <div>
      <label>Name</label>
      <input name="name" value="{{ b.name }}" required>
    </div>
    <div>
      <label>Yield</label>
      <input name="yield_qty" type="number" step="any" value="{{ b.yield_qty }}" required style="width:10rem">
      <select name="yield_unit" required>
        {% for u in ['g','kg','oz','lb','ml','l'] %}
          <option value="{{ u }}" {% if b.yield_unit==u %}selected{% endif %}>{{ u }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="flex:1; min-width:240px;">
      <label>Notes</label>
      <input name="notes" value="{{ b.notes or '' }}">
    </div>
  </div>
  <button type="submit">Save Changes</button>
</form>

<!-- Delete Batch -->
<form action="{{ url_for('batch_delete', batch_id=b.id) }}" method="post"
      onsubmit="return confirm('Delete this batch? This cannot be undone.');"
      class="card" style="margin-bottom:1rem; background:#fee;">
  <button type="submit">Delete Batch</button>
</form>

<p><strong>Yield:</strong> {{ b.yield_qty }} {{ b.yield_unit }}</p>
{% if b.notes %}<p>{{ b.notes }}</p>{% endif %}

<hr>

<h3>Add inventory ingredient</h3>
<form action="{{ url_for('batch_detail', batch_id=b.id) }}" method="post" class="card" style="margin-bottom:1rem;">
  <div>
    <label>Item</label>
    <select name="item_id" required>
      {% for i in items %}
        <option value="{{ i.id }}">{{ i.name }} ({{ i.unit }}) â€” ${{ '%.4f' % i.unit_cost }}/{{ i.unit }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Qty</label>
    <input name="qty" type="number" step="any" required style="width:10rem">
    <select name="unit" required>
      <option>g</option><option>kg</option><option>oz</option>
      <option>lb</option><option>ml</option><option>l</option>
    </select>
  </div>
  <button type="submit">Add ingredient</button>
</form>

<table class="table">
  <thead>
    <tr><th>Item</th><th>Qty</th><th>Ext Cost</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% if b.ingredients|length == 0 %}
    <tr><td colspan="4" style="opacity:.7;">No inventory ingredients yet.</td></tr>
  {% else %}
    {% for ing in b.ingredients %}
      <tr>
        <td>{{ ing.item.name }}</td>
        <td>
          <form method="post" action="{{ url_for('batch_update_ingredient', batch_id=b.id, ing_id=ing.id) }}" class="d-flex gap-2">
            <input name="qty" type="number" step="any" value="{{ ing.qty }}" style="width:7rem">
            <input name="unit" value="{{ ing.unit }}" style="width:5rem">
            <button>Update</button>
          </form>
        </td>
        <td>${{ '%.2f' % ing.ext_cost }}</td>
        <td><a href="{{ url_for('batch_delete_ing', batch_id=b.id, ing_id=ing.id) }}">Remove</a></td>
      </tr>
    {% endfor %}
  {% endif %}
  </tbody>
</table>

<hr>

<h3>Add sub-batch</h3>
<form action="{{ url_for('batch_add_subbatch', batch_id=b.id) }}" method="post" class="card" style="margin-bottom:1rem;">
  <div>
    <label>Batch</label>
    <select name="child_id" required>
      {% for sb in all_batches if sb.id != b.id %}
        <option value="{{ sb.id }}">{{ sb.name }} (yields {{ sb.yield_qty }} {{ sb.yield_unit }})</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Portion</label>
    <input name="qty" type="number" step="any" required style="width:10rem">
    <select name="unit" required>
      <option>g</option><option>kg</option><option>oz</option>
      <option>lb</option><option>ml</option><option>l</option>
    </select>
  </div>
  <button type="submit">Add sub-batch</button>
</form>

<table class="table">
  <thead>
    <tr><th>Batch</th><th>Portion</th><th>Ext Cost</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% if b.sub_batches|length == 0 %}
    <tr><td colspan="4" style="opacity:.7;">No sub-batches yet.</td></tr>
  {% else %}
    {% for sb in b.sub_batches %}
      <tr>
        <td>{{ sb.child.name }}</td>
        <td>
          <form method="post" action="{{ url_for('batch_update_subbatch', batch_id=b.id, sb_id=sb.id) }}" class="d-flex gap-2">
            <input name="qty" type="number" step="any" value="{{ sb.qty }}" style="width:7rem">
            <input name="unit" value="{{ sb.unit }}" style="width:5rem">
            <button>Update</button>
          </form>
        </td>
        <td>${{ '%.2f' % sb.ext_cost }}</td>
        <td><a href="{{ url_for('batch_delete_subbatch', batch_id=b.id, sb_id=sb.id) }}">Remove</a></td>
      </tr>
    {% endfor %}
  {% endif %}
  </tbody>
</table>

<hr>

<p><strong>Total cost:</strong> ${{ '%.2f' % b.total_cost }}</p>
{% endblock %}
